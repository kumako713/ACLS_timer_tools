<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ACLS Timer Tool</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      margin: 0; padding: 20px;
      display: flex; flex-direction: column; align-items: center;
    }
    .center-row {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 15px;
      gap: 10px;
      width: 100%;
    }
    .split-row {
      display: flex;
      justify-content: center;
      gap: 40px;
      width: 100%;
    }
    .column {
      width: 45%;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }
    button {
      padding: 6px 10px;
      font-size: 13px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      width: 100%;
      max-width: 160px;
    }
    .selected { background-color: black !important; color: white !important; }
    .iron-gray { background-color: #4e4e4e; /* ÈêµÁÅ∞Ëâ≤ */
                 color: white; border: none; border-radius: 6px; padding: 6px 12px; }
    .red { background-color: #e53935; color: white; }
    .darkred { background-color: #8B0000; color: white; }
    .yellow { background-color: #fbc02d; color: black; }
    .green { background-color: #40e0d0; color: black; }
    .blue { background-color: #4fc3f7; color: black; }
    .gray { background-color: #b0bec5; color: black; }
    .shoke { background-color: #e53935; color: yellow; font-weight: bold; }
    .brown { background-color: #d2b48c; color: black; }
    .orange { background-color: orange; color: black; }
    .dark { background-color: black; color: white; }
    .light { background-color: white; color: black; border: 1px solid #333; }
    .toggled { background-color: #555 !important; color: white !important; text-decoration: line-through; }
    .input-label { font-size: 16px; margin-left: 10px; }
    #log {
      margin-top: 20px;
      white-space: pre-line;
      border-top: 1px solid #ccc;
      padding-top: 10px;
      width: 100%;
      max-width: 1000px;
      text-align: left;
    }
    #countInfo, #clock {
      font-size: 18px;
      color: #333;
    }
    .header-text {
      font-size: 24px;
      background-color: #e53935;
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      text-align: center;
    }
  </style>
</head>
<body>

<div id="toast" style="position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
background-color: rgba(0, 0, 0, 0.7); color: yellow; padding: 10px 20px; border-radius: 6px;
opacity: 0; transition: opacity 0.5s; z-index: 9999; pointer-events: none; font-size: 24px;">
</div>

<audio id="beepSound" src="beep_logic110_1.mp3" loop></audio>
  
<!-- Ê®ôÈ°åËàáÊôÇÈñì -->
<div class="center-row"><div class="header-text">ACLS Timer Tool</div></div>
<div class="center-row"><div id="clock"></div></div>

<!-- ÊÄßÂà•ËàáÂπ¥ÈΩ° -->
<div class="center-row">
  <button class="gray" id="maleBtn" onclick="toggleGender('male')">Male</button>
  <button class="gray" id="femaleBtn" onclick="toggleGender('female')">Female</button>
  <input type="number" id="ageInput" style="width: 6ch; padding: 2px 4px; margin-right: 2px;" />
  <span style="font-size: 16px;">Y</span>
</div>

<!-- Áµ¶Ëó•ËàáËôïÁΩÆÁ¥ÄÈåÑÂçÄÂ°ä -->
<div class="split-row">
<!-- Â∑¶ÈÇäÊ¨Ñ‰Ωç -->
<div class="column" style="align-items: flex-start;">
  <div><strong>Epinephrine:</strong> <span id="epiCount">0</span></div>
  <div><strong>Amiodarone:</strong> <span id="amioCount">0</span></div>
  <div><strong>Lidocaine:</strong> <span id="lidoCount">0</span></div>
  <div><strong>Shock:</strong> <span id="shockCount">0</span></div>
<!-- HR Âêå‰∏ÄÂàó -->
<div style="display: flex; align-items: center; margin-top: 12px;">
  <strong style="margin-right: 8px;">HR</strong>
  <input type="text" id="hrInput" style="width: 40px;" />
</div>

<!-- BP Âêå‰∏ÄÂàó -->
<div style="display: flex; align-items: center; margin-top: 12px;">
  <strong style="margin-right: 8px;">BP</strong>
  <input type="text" id="bpSysInput" style="width: 35px; margin-right: 4px;" />
  <span>/</span>
  <input type="text" id="bpDiaInput" style="width: 35px; margin-left: 4px;" />
</div>
  
  <!-- SpO2 ÊîπÁÇ∫Á≤óÈ´î‰∏¶ÊèõË°åÈ°ØÁ§∫Ëº∏ÂÖ•Ê°ÜËàá % -->
  <div style="display: flex; align-items: center; gap: 6px; margin-top: 4px;">
  <strong style="margin-right: 8px;">SpO‚ÇÇ</strong>
  <input type="text" id="spo2Left" style="width: 35px;" />
  <span>‚Üí</span>
  <input type="text" id="spo2Right" style="width: 35px;" />
  <span>%</span>
</div>

  <!-- BT ÊîπÁÇ∫Á≤óÈ´î‰∏îËàáËº∏ÂÖ•Ê°ÜÂêåË°åÔºåÈ°ØÁ§∫Â∫¶C -->
  <div style="display: flex; align-items: center; margin-top: 12px;">
    <strong style="font-size: 16px; margin-right: 8px;">BT</strong>
    <input type="text" id="btInput" style="width: 40px; margin-right: 6px;" />
    <span>¬∞C</span>
  </div>

  <!-- Á©∫ÁôΩÂçÄÈöî -->
  <div style="height: 20px;"></div>
</div>
  <!-- Âè≥ÈÇäÊ¨Ñ‰Ωç -->
  <div class="column" style="align-items: flex-start;">
    <label for="chiefComplaint" style="font-weight: bold; font-size: 14px; margin-bottom: 5px;">Chief Complaint</label>
    <textarea id="chiefComplaint" rows="1" style="width: 100%; font-size: 14px; padding: 6px;"></textarea>
    
    <label for="history" style="font-weight: bold; font-size: 14px; margin-bottom: 5px;">History/ Allergy</label>
    <textarea id="history" rows="1" style="width: 100%; font-size: 14px; padding: 6px;"></textarea>

    <label for="otherNotes" style="font-weight: bold; font-size: 14px; margin-top: 10px; margin-bottom: 5px;">Other Treatments</label>
    <textarea id="otherNotes" rows="1" style="width: 100%; font-size: 14px; padding: 6px;"></textarea>
  </div>
</div>
<div style="height: 20px;"></div>

<!-- Êìç‰ΩúÊåâÈàïËàá5H5T -->
<div class="split-row">
  <div class="column">
    <button class="red" onclick="startCPR()">CPR</button>
    <button class="red" onclick="aedAnalyze()">AED Analyze</button>
    <button class="red" onclick="switchCPR()">Switch CPR</button>
    <button class="shoke" onclick="recordShock()">‚ö°Ô∏è‚ö°Ô∏èShock‚ö°Ô∏è‚ö°Ô∏è</button>
    <button class="darkred" onclick="stopCPR()">Stop CPR</button>
    <button class="yellow" onclick="giveEpinephrine()">Epinephrine</button>
    <button class="yellow" id="amioBtn" onclick="giveAmiodarone()">Amiodarone</button>
    <button class="yellow" id="lidoBtn" onclick="giveLidocaine()">Lidocaine</button>
    <button class="green" onclick="recordEvent('IV')">I.V.</button>
    <button class="green" onclick="recordEvent('IO')">I.O.</button>
    <button class="green" onclick="recordEndoTube()">Endo</button>
  </div>
  <div class="column">
    <button class="brown" onclick="toggleMarker(this)">Hypothermia</button>
    <button class="brown" onclick="toggleMarker(this)">Hypoxia</button>
    <button class="brown" onclick="toggleMarker(this)">Hypovolemia</button>
    <button class="brown" onclick="toggleMarker(this)">Hydrogen</button>
    <button class="brown" onclick="toggleMarker(this)">Hypo/Hyperkalemia</button>
    <button class="orange" onclick="toggleMarker(this)">Thrombosis/Coronary</button>
    <button class="orange" onclick="toggleMarker(this)">Thrombosis/Pulmonary</button>
    <button class="orange" onclick="toggleMarker(this)">Tamponade</button>
    <button class="orange" onclick="toggleMarker(this)">Toxins</button>
    <button class="orange" onclick="toggleMarker(this)">Tension pneumothorax</button>
  </div>
</div>
  
<!-- Á©∫Ë°å -->
<div style="height: 20px;"></div>

<!-- Mute -->
<div class="center-row">
  <button id="muteBtn" class="dark" onclick="toggleMute()">Mute</button>
</div>

<!-- ROSC Ëàá ISBAR -->
<div class="center-row">
  <button class="blue" onclick="recordEvent('ROSC')">ROSC</button>
  <button class="gray" onclick="showISBAR()">ISBAR</button>
</div>

<!-- Reset -->
<div class="center-row">
  <button class="iron-gray" onclick="resetLog()">Reset</button>
</div>

<!-- Á¥ÄÈåÑÂçÄ -->
<div id="log"></div>

<!-- JavaScript ÂäüËÉΩ -->
<script>
let startTime = null;
let epiCount = 0, amioCount = 0, lidoCount = 0, shockCount = 0;
let timers = [];
let endoFixCm = null;

function showToast(message) {
  const toast = document.getElementById("toast");
  toast.innerText = message;
  toast.style.opacity = "1";

  setTimeout(() => {
    toast.style.opacity = "0";
  }, 2000); // 2 ÁßíÂæåÊ∑°Âá∫
}

function updateClock() {
  const now = new Date();
  document.getElementById("clock").innerText =
    "Current TimeÔºö" + now.toLocaleString('zh-TW', { hour12: false });
}
setInterval(updateClock, 1000); updateClock();

function recordEvent(event) {
  const now = new Date();
  if (!startTime) startTime = now;
  const elapsed = Math.floor((now - startTime) / 1000);
  const timeStamp = `${Math.floor(elapsed / 60).toString().padStart(2, '0')}:${(elapsed % 60).toString().padStart(2, '0')}`;
  const nowTime = now.toLocaleTimeString('zh-TW', { hour12: false });

  const logContainer = document.getElementById("log");
  const logEntry = document.createElement("div");
  logEntry.style.display = "flex";
  logEntry.style.alignItems = "center";
  logEntry.style.justifyContent = "space-between";
  logEntry.style.marginBottom = "4px";

  const logText = document.createElement("span");
  logText.textContent = `[${timeStamp}] [${nowTime}] ${event}`;
  logText.style.flex = "1";

  // ‚úÖ Ê†πÊìö event ÊñáÂ≠óÂÖßÂÆπÊ±∫ÂÆöÊ®£Âºè
if (/Epinephrine|Amiodarone|Lidocaine/.test(event)) {
  logText.style.backgroundColor = "blue";
  logText.style.color = "white";
  logText.style.fontWeight = "bold";
  logText.style.padding = "2px 6px";
  logText.style.borderRadius = "4px";
} else if (/Shock/.test(event)) {
  logText.style.backgroundColor = "red";
  logText.style.color = "yellow";
  logText.style.fontWeight = "bold";
  logText.style.padding = "2px 6px";
  logText.style.borderRadius = "4px";
} else if (/^(IV|IO|Endo|Endo Fix \d{2} cm)$/.test(event)) {
  logText.style.backgroundColor = "green";
  logText.style.color = "white";
  logText.style.fontWeight = "bold";
  logText.style.padding = "2px 6px";
  logText.style.borderRadius = "4px";
} else if (/ROSC/.test(event)) {
  logText.style.backgroundColor = "#4fc3f7"; // Â§©Á©∫Ëóç
  logText.style.color = "white";
  logText.style.fontWeight = "bold";
  logText.style.padding = "2px 6px";
  logText.style.borderRadius = "4px";
}
  
  const delBtn = document.createElement("button");
  delBtn.textContent = "Âà™Èô§";
  delBtn.style.marginLeft = "10px";
  delBtn.style.backgroundColor = "#f44336";
  delBtn.style.color = "white";
  delBtn.style.border = "none";
  delBtn.style.borderRadius = "4px";
  delBtn.style.cursor = "pointer";
  delBtn.onclick = function () {
  if (confirm("ÊòØÂê¶Âà™Èô§Ôºü")) {
    const text = logText.textContent;

    // Ê™¢Êü•Âà™Èô§ÁöÑÊòØÂì™ÂÄãËó•Áâ©Á¥ÄÈåÑ
    if (text.includes("Amiodarone")) {
      amioCount = Math.max(0, amioCount - 1);
      document.getElementById("amioCount").innerText = amioCount;
      const btn = document.getElementById("amioBtn");
      btn.disabled = amioCount >= 2;
      btn.style.opacity = btn.disabled ? 0.5 : 1;
    }

    if (text.includes("Lidocaine")) {
      lidoCount = Math.max(0, lidoCount - 1);
      document.getElementById("lidoCount").innerText = lidoCount;
      const btn = document.getElementById("lidoBtn");
      btn.disabled = lidoCount >= 2;
      btn.style.opacity = btn.disabled ? 0.5 : 1;
    }

    logContainer.removeChild(logEntry);  // ‚úÖ Ê≠£Á¢∫ÁßªÈô§Á¥ÄÈåÑ
    updateCountsFromLog();               // ‚úÖ ÂêåÊ≠•Êõ¥Êñ∞Ë®àÊï∏
  }
};

  logEntry.appendChild(logText);
  logEntry.appendChild(delBtn);
  logContainer.appendChild(logEntry);
  showToast(event);  // ‚úÖ È°ØÁ§∫Ë®äÊÅØ
}
let beatInterval = null;

function aedAnalyze() {
  recordEvent("AED ÂàÜÊûê‰∏≠‚Ä¶‚Ä¶");

  // Êö´ÊôÇÈùúÈü≥Èü≥ÊïàÔºà‰ΩÜ‰øùÊåÅÊí≠Êîæ‰∏ç‰∏≠Êñ∑Ôºâ
  muteBeep();

  setTimeout(() => {
    recordEvent("AED ÂàÜÊûêÂÆåÁï¢");
    unmuteBeep();

    // ÊñºÂàÜÊûêÂÆåÁï¢ÂæåÈñãÂßãË®àÁÆóË∑≥Âá∫ÊèêÈÜíÊôÇÈñì
    timers.push(setTimeout(() => alert("30ÁßíÂæåÂàÜÊûêÂøÉÂæã"), 90000));
    timers.push(setTimeout(() => alert("10ÁßíÂæåÂàÜÊûêÂøÉÂæã"), 110000));
  }, 10000);
}

function switchCPR() {
  recordEvent("CPR Êèõ‰∫∫");
  setTimeout(() => alert("2ÂàÜÈêòÂ∑≤Âà∞ÔºåË´ãËÄÉÊÖÆ CPR Êèõ‰∫∫"), 120000);
}
function giveEpinephrine() {
  alert("1mg IVP");
  recordEvent("Epinephrine 1mg Áµ¶Ëó•");
  document.getElementById("epiCount").innerText = ++epiCount;
  updateCountsFromLog();
}
function giveAmiodarone() {
  if (++amioCount === 1) {
    alert("300mg IVP (ËÄÉÊÖÆLidocaine?)");
    recordEvent("Amiodarone 300mg Áµ¶Ëó•");
    updateCountsFromLog();  // ‚úÖ Âä†Âú®ÈÄôË£°
  } else if (amioCount === 2) {
    alert("150mg IVP");
    recordEvent("Amiodarone 150mg Áµ¶Ëó•");
    updateCountsFromLog();  // ‚úÖ Âä†Âú®ÈÄôË£°
    const btn = document.getElementById("amioBtn");
    btn.disabled = true;
    btn.style.opacity = 0.5;
  }
  document.getElementById("amioCount").innerText = amioCount;
}
  
function giveLidocaine() {
  if (++lidoCount === 1) {
    alert("1-1.5mg/kg IVP");
    recordEvent("Lidocaine ÂäëÈáè(?)mg");
    updateCountsFromLog();  // ‚úÖ Âä†Âú®ÈÄô
  } else if (lidoCount === 2) {
    alert("0.5-0.75mg/kg IVP");
    recordEvent("Lidocaine ÂäëÈáè(?)mg");
    updateCountsFromLog();  // ‚úÖ Âä†Âú®ÈÄô
    const btn = document.getElementById("lidoBtn");
    btn.disabled = true;
    btn.style.opacity = 0.5;
  }
  document.getElementById("lidoCount").innerText = lidoCount;
}

function recordShock() {
  recordEvent("Shock!");
  document.getElementById("shockCount").innerText = ++shockCount;
  updateCountsFromLog();
}
function recordEndoTube() {
  const cm = prompt("Á¢∫Ë™ç Fix\nË´ãËº∏ÂÖ•Êï∏ÂÄºÔºà19-23cmÔºâÊàñÂèñÊ∂àÔºö", "20");
  if (cm && ["19", "20", "21", "22", "23"].includes(cm)) {
    endoFixCm = cm; // ‚úÖ ÂÑ≤Â≠ò‰ΩøÁî®ËÄÖËº∏ÂÖ•ÁöÑ cm ÂÄº
    recordEvent(`Endo Fix ${cm} cm`);
  }
}
function resetLog() {
  if (confirm("Á¢∫ÂÆöË¶ÅÊ∏ÖÈô§ÊâÄÊúâÁ¥ÄÈåÑÔºü")) {
    // Ê∏ÖÈô§Á¥ÄÈåÑÂçÄ
    document.getElementById("log").innerHTML = "";

    // Ê∏ÖÈô§Ëº∏ÂÖ•Ê¨Ñ‰Ωç
    const inputs = document.querySelectorAll("input[type='text'], input[type='number'], textarea");
    inputs.forEach(input => input.value = "");

    // ÂÅúÊ≠¢ÊâÄÊúâË®àÊôÇÂô®
    if (timers && Array.isArray(timers)) {
      timers.forEach(t => clearTimeout(t) || clearInterval(t));
    }
    timers = [];

    // ÂÅúÊ≠¢ËÅ≤Èü≥
    stopBeepLoop();

    // Ê∏ÖÈô§Ëµ∑ÂßãÊôÇÈñì
    startTime = null;

    // ÈÇÑÂéüÊåâÈàïÊ®£Âºè
    const toggleButtons = document.querySelectorAll(".toggled, .selected");
    toggleButtons.forEach(btn => {
      btn.classList.remove("toggled");
      btn.classList.remove("selected");
      btn.disabled = false;
      btn.style.opacity = 1;
    });

    // ÈáçË®≠ Mute ÊåâÈàïÊ®£ÂºèËàáÁãÄÊÖã
    const muteBtn = document.getElementById("muteBtn");
    if (muteBtn) {
      muteBtn.innerText = "Mute";
      muteBtn.className = "dark";
    }
    isMuted = false;

    // ÈáçË®≠Ëó•Áâ©Ëàá shock Ê¨°Êï∏
    epiCount = 0;
    amioCount = 0;
    lidoCount = 0;
    shockCount = 0;
    document.getElementById("epiCount").innerText = "0";
    document.getElementById("amioCount").innerText = "0";
    document.getElementById("lidoCount").innerText = "0";
    document.getElementById("shockCount").innerText = "0";
  }
}

function updateCountsFromLog() {
  const logs = document.querySelectorAll("#log div span");
  let epi = 0, amio = 0, lido = 0, shock = 0;

  logs.forEach(span => {
    const text = span.textContent;
    if (text.includes("Epinephrine")) epi++;
    if (text.includes("Amiodarone")) amio++;
    if (text.includes("Lidocaine")) lido++;
    if (text.includes("Shock!")) shock++;
  });

  epiCount = epi;
  amioCount = amio;
  lidoCount = lido;
  shockCount = shock;

  document.getElementById("epiCount").innerText = epiCount;
  document.getElementById("amioCount").innerText = amioCount;
  document.getElementById("lidoCount").innerText = lidoCount;
  document.getElementById("shockCount").innerText = shockCount;

  const amioBtn = document.getElementById("amioBtn");
  const lidoBtn = document.getElementById("lidoBtn");

  if (amioBtn) {
    amioBtn.disabled = amioCount >= 2;
    amioBtn.style.opacity = amioBtn.disabled ? 0.5 : 1;
  }
  if (lidoBtn) {
    lidoBtn.disabled = lidoCount >= 2;
    lidoBtn.style.opacity = lidoBtn.disabled ? 0.5 : 1;
  }
}

function toggleGender(selected) {
  const maleBtn = document.getElementById("maleBtn");
  const femaleBtn = document.getElementById("femaleBtn");
  if (selected === 'male') {
    maleBtn.classList.toggle('selected');
    femaleBtn.classList.remove('selected');
  } else {
    femaleBtn.classList.toggle('selected');
    maleBtn.classList.remove('selected');
  }
}
function toggleMarker(btn) {
  btn.classList.toggle('toggled');
}
  let isMuted = false;

function toggleMute() {
  const btn = document.getElementById("muteBtn");
  isMuted = !isMuted;
  btn.innerText = isMuted ? "Unmute" : "Mute";
  btn.className = isMuted ? "light" : "dark";
  
  const beep = document.getElementById("beepSound");
  if (beep) beep.volume = isMuted ? 0 : 1;
}

function playBeep() {
  if (isMuted) return;
  const beep = document.getElementById("beepSound");
  beep.currentTime = 0;
  beep.play();
}
function startBeepLoop() {
  const beep = document.getElementById("beepSound");
  beep.volume = 1;
  beep.currentTime = 0;
  beep.play();
}

function muteBeep() {
  const beep = document.getElementById("beepSound");
  beep.volume = 0;
}

function unmuteBeep() {
  const beep = document.getElementById("beepSound");
  beep.volume = 1;
}

function stopBeepLoop() {
  const beep = document.getElementById("beepSound");
  beep.pause();
  beep.currentTime = 0;
  beep.volume = 0;
}
function startCPR() {
  recordEvent("CPR ÈñãÂßã");
  if (!startTime) startTime = new Date();

  timers.push(setInterval(() => alert("ÊèêÈÜíÔºöCPR Âü∑Ë°å‰∏≠ÔºåË´ãËÄÉÊÖÆ 5H5TÔºü"), 120000));

  setTimeout(() => {
    startBeepLoop(); // üîä Âª∂ÈÅ≤ 1 ÁßíÊí≠ÊîæÂæ™Áí∞Èü≥Êïà
  }, 1000);
}


function stopCPR() {
  recordEvent("CPR ÂÅúÊ≠¢");
  timers.forEach(t => clearTimeout(t) || clearInterval(t));
  timers = [];
  stopBeepLoop(); // üõë ÂÅúÊ≠¢Èü≥ÊïàÊí≠Êîæ
}
function showISBAR() {
  const chief = document.getElementById("chiefComplaint")?.value || "ÔºàÊú™Â°´ÂØ´Ôºâ";
  const history = document.getElementById("history")?.value || "ÔºàÊú™Â°´ÂØ´Ôºâ";
  const otherNotes = document.getElementById("otherNotes")?.value || "ÔºàÊú™Â°´ÂØ´Ôºâ";
  const age = document.getElementById("ageInput")?.value || "Ôºü";
  let gender = "ÔºàÊú™ÈÅ∏Ôºâ";
  if (document.getElementById("maleBtn").classList.contains("selected")) {
    gender = "Áî∑ÊÄß";
  } else if (document.getElementById("femaleBtn").classList.contains("selected")) {
    gender = "Â•≥ÊÄß";
  }
  const spo2Left = document.querySelector("#spo2Left")?.value || "??";
  const spo2Right = document.querySelector("#spo2Right")?.value || "??";
  const btValue = document.getElementById("btInput")?.value || "??";
  const hrValue = document.getElementById("hrInput")?.value || "??";
  const bpSys = document.getElementById("bpSysInput")?.value || "??";
  const bpDia = document.getElementById("bpDiaInput")?.value || "??";


  let cprStart = null, cprStop = null;
  const logs = document.querySelectorAll("#log div span");
  logs.forEach(span => {
    const text = span.textContent;
    if (text.includes("CPR ÈñãÂßã")) cprStart = extractTime(text);
    if (text.includes("CPR ÂÅúÊ≠¢")) cprStop = extractTime(text);
  });
  let roscTime = "Â∞öÁÑ°Á¥ÄÈåÑ";
  for (let i = 0; i < logs.length; i++) {
    const text = logs[i].textContent;
    if (text.includes("ROSC")) {
      const match = text.match(/\[(\d{2}:\d{2}:\d{2})\]/);  // Êäì current time
      if (match) {
        roscTime = match[1];
      }
      break;
  }
}
  let cprDuration = "ÔºàÂ∞öÊú™ÁµêÊùüÔºâ";
  if (cprStart && cprStop) {
    const mins = Math.floor((cprStop - cprStart) / 60000);
    cprDuration = `${mins} ÂàÜÈêò`;
  }

  const medStats = {};
  logs.forEach(span => {
    const text = span.textContent;
    const match = text.match(/\[(\d{2}:\d{2}:\d{2})\] .*?(Epinephrine|Amiodarone|Lidocaine).*?Áµ¶Ëó•/);
    if (match) {
      const [_, time, name] = match;
      if (!medStats[name]) medStats[name] = { count: 0, last: null };
      medStats[name].count++;
      medStats[name].last = time;
    }
  });

  let lastMedLine = "";
for (let i = logs.length - 1; i >= 0; i--) {
  const text = logs[i].textContent;
  if (/Áµ¶Ëó•/.test(text)) {
    const match = text.match(/(Epinephrine|Amiodarone|Lidocaine).*?Áµ¶Ëó•.*?/);
    if (match) {
      const med = match[1];
      const dose = text.split("Áµ¶Ëó•")[0].split(med)[1].trim();
      const currentTime = new Date().toLocaleTimeString('zh-TW', { hour12: false });
      lastMedLine = `${currentTime} ${med}${dose ? " " + dose : ""}`;
      break;
    }
  }
}

  let endoInfo = "Â∞öÁÑ°Á¥ÄÈåÑ";
for (let i = logs.length - 1; i >= 0; i--) {
  const text = logs[i].textContent;
  const match = text.match(/Fix (\d{2})cm/);
  if (match) {
    endoInfo = `Fix ${match[1]}cm`;
    break;
  }
}
 const aText = `A:
 (ÂøÉÈõªÂúñËá™Ë°åÂà§Êñ∑)
 Áµ¶‰∫àËó•Áâ©
 EpinephrineÔºö${medStats.Epinephrine?.count || 0} Ê¨°
 AmiodaroneÔºö${medStats.Amiodarone?.count || 0} Ê¨°
 LidocaineÔºö${medStats.Lidocaine?.count || 0} Ê¨°

 Shock Ê¨°Êï∏Ôºö${document.getElementById("shockCount").innerText} Ê¨°

 Endo(ËôüÊï∏)Ôºö${endoFixCm ? endoFixCm + " cm" : "??"}
 
 ÊúÄÂæå‰∏ÄÊ¨°Áµ¶Ëó•
 ${lastMedLine || "??"}

 ÂÖ∂‰ªñËôïÁΩÆ/Ëó•Áâ©Ôºö${otherNotes}
 `;

  const isbar = `
„ÄêISBAR ÂΩôÊï¥„Äë
IÔºö
ÈÜ´Â∏´Â•ΩÔºåÊàëÊòØÁΩ≤P91„ÄÇ

SÔºö
${gender}ÊÇ£ËÄÖ ${age} Ê≠≤Ôºå${chief}ÔºåHR ${hrValue}ÔºåBP ${bpSys}/${bpDia}ÔºåSpO‚ÇÇ ${spo2Left}‚Üí${spo2Right}%ÔºåCPR Â∑≤ÊåÅÁ∫å ${cprDuration}ÔºåROSC ÊôÇÈñìÔºö${roscTime}
„ÄÇ

BÔºö
ÁóÖÂè≤/ÈÅéÊïèÂè≤Ôºö ${history}„ÄÇ

${aText}

RÔºö
Âª∫Ë≠∞ÔºöË´ãËá™Ë°åË©ï‰º∞„ÄÇ
  `;
  // ÂèñÂæó‰∏ãÊñπ log ÊâÄÊúâÁ¥ÄÈåÑÂÖßÂÆπ
const logText = Array.from(document.querySelectorAll("#log div span"))
  .map(span => span.textContent)
  .join("\n");

// Âêà‰Ωµ ISBAR ËàáËôïÁΩÆÁ¥ÄÈåÑ
const fullText = `${isbar}\n\n„ÄêËôïÁΩÆÁ¥ÄÈåÑ„Äë\n${logText}`;

// Ë§áË£ΩÊï¥ÂêàÂæåÊñáÂ≠ó
navigator.clipboard.writeText(fullText);

// ÂÉÖÂΩàÂá∫ ISBAR Êú¨È´î
alert(isbar);
}

function extractTime(text) {
  const match = text.match(/\[(\d{2}:\d{2}:\d{2})\]/);
  return match ? new Date("1970-01-01T" + match[1] + "Z") : null;
}
</script>

</body>
</html>
