<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ACLS Timer Tool</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      margin: 0; padding: 20px;
      display: flex; flex-direction: column; align-items: center;
    }
    .center-row {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 15px;
      gap: 10px;
      width: 100%;
    }
    .split-row {
      display: flex;
      justify-content: center;
      gap: 40px;
      width: 100%;
    }
    .column {
      width: 45%;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }
    button {
      padding: 6px 10px;
      font-size: 13px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      width: 100%;
      max-width: 160px;
    }
    .selected { background-color: black !important; color: white !important; }
    .iron-gray { background-color: #4e4e4e; /* éµç°è‰² */
                 color: white; border: none; border-radius: 6px; padding: 6px 12px; }
    .red { background-color: #e53935; color: white; }
    .darkred { background-color: #8B0000; color: white; }
    .yellow { background-color: #fbc02d; color: black; }
    .green { background-color: #40e0d0; color: black; }
    .blue { background-color: #4fc3f7; color: black; }
    .gray { background-color: #b0bec5; color: black; }
    .shoke { background-color: #e53935; color: yellow; font-weight: bold; }
    .brown { background-color: #d2b48c; color: black; }
    .orange { background-color: orange; color: black; }
    .dark { background-color: black; color: white; }
    .light { background-color: white; color: black; border: 1px solid #333; }
    .toggled { background-color: #555 !important; color: white !important; text-decoration: line-through; }
    .input-label { font-size: 16px; margin-left: 10px; }
    #log {
      margin-top: 20px;
      white-space: pre-line;
      border-top: 1px solid #ccc;
      padding-top: 10px;
      width: 100%;
      max-width: 1000px;
      text-align: left;
    }
    #countInfo, #clock {
      font-size: 18px;
      color: #333;
    }
    .header-text {
      font-size: 32px;
      background-color: #e53935;
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      text-align: center;
    }
  </style>
</head>
<body>
<audio id="beepSound" src="beep_logic110.mp3" loop></audio>
  
<!-- æ¨™é¡Œèˆ‡æ™‚é–“ -->
<div class="center-row"><div class="header-text">ACLS Timer Tool</div></div>
<div class="center-row"><div id="clock"></div></div>

<!-- æ€§åˆ¥èˆ‡å¹´é½¡ -->
<div class="center-row">
  <button class="gray" id="maleBtn" onclick="toggleGender('male')">Male</button>
  <button class="gray" id="femaleBtn" onclick="toggleGender('female')">Female</button>
  <input type="number" id="ageInput" style="width: 6ch; padding: 2px 4px; margin-right: 2px;" />
  <span style="font-size: 16px;">Y</span>
</div>

<!-- çµ¦è—¥èˆ‡è™•ç½®ç´€éŒ„å€å¡Š -->
<div class="split-row">
<!-- å·¦é‚Šæ¬„ä½ -->
<div class="column" style="align-items: flex-start;">
  <div><strong>Epinephrine:</strong> <span id="epiCount">0</span></div>
  <div><strong>Amiodarone:</strong> <span id="amioCount">0</span></div>
  <div><strong>Lidocaine:</strong> <span id="lidoCount">0</span></div>
  <div><strong>Shock:</strong> <span id="shockCount">0</span></div>

  <!-- SpO2 æ”¹ç‚ºç²—é«”ä¸¦æ›è¡Œé¡¯ç¤ºè¼¸å…¥æ¡†èˆ‡ % -->
  <div style="margin-top: 12px;"><strong>SpOâ‚‚</strong></div>
  <div style="display: flex; align-items: center; margin-top: 4px;">
  <input type="text" id="spo2Left" style="width: 60px; margin-right: 6px;" />
  <span style="margin: 0 6px;">â†’</span>
  <input type="text" id="spo2Right" style="width: 60px; margin-right: 6px;" />
  <span>%</span>
</div>

  <!-- BT æ”¹ç‚ºç²—é«”ä¸”èˆ‡è¼¸å…¥æ¡†åŒè¡Œï¼Œé¡¯ç¤ºåº¦C -->
  <div style="display: flex; align-items: center; margin-top: 12px;">
    <strong style="margin-right: 8px;">BT</strong>
    <input type="text" id="btInput" style="width: 60px; margin-right: 6px;" />
    <span>Â°C</span>
  </div>

  <!-- ç©ºç™½å€éš” -->
  <div style="height: 20px;"></div>
</div>
  <!-- å³é‚Šæ¬„ä½ -->
  <div class="column" style="align-items: flex-start;">
    <label for="chiefComplaint" style="font-weight: bold; margin-bottom: 5px;">Chief Complant</label>
    <textarea id="chiefComplaint" rows="2" style="width: 100%; font-size: 14px; padding: 6px;"></textarea>
    
    <label for="history" style="font-weight: bold; margin-bottom: 5px;">History/ Allergy</label>
    <textarea id="history" rows="2" style="width: 100%; font-size: 14px; padding: 6px;"></textarea>

    <label for="otherNotes" style="font-weight: bold; margin-top: 10px; margin-bottom: 5px;">Other Treatments</label>
    <textarea id="otherNotes" rows="2" style="width: 100%; font-size: 14px; padding: 6px;"></textarea>
  </div>
</div>
<div style="height: 20px;"></div>

<!-- æ“ä½œæŒ‰éˆ•èˆ‡5H5T -->
<div class="split-row">
  <div class="column">
    <button class="red" onclick="startCPR()">CPR</button>
    <button class="red" onclick="aedAnalyze()">AED Analyze</button>
    <button class="red" onclick="switchCPR()">Switch CPR</button>
    <button class="shoke" onclick="recordShock()">âš¡ï¸âš¡ï¸Shockâš¡ï¸âš¡ï¸</button>
    <button class="darkred" onclick="stopCPR()">Stop CPR</button>
    <button class="yellow" onclick="giveEpinephrine()">Epinephrine</button>
    <button class="yellow" id="amioBtn" onclick="giveAmiodarone()">Amiodarone</button>
    <button class="yellow" id="lidoBtn" onclick="giveLidocaine()">Lidocaine</button>
    <button class="green" onclick="recordEvent('IV')">I.V.</button>
    <button class="green" onclick="recordEvent('IO')">I.O.</button>
    <button class="green" onclick="recordEndoTube()">Endo</button>
  </div>
  <div class="column">
    <button class="brown" onclick="toggleMarker(this)">Hypothermia</button>
    <button class="brown" onclick="toggleMarker(this)">Hypoxia</button>
    <button class="brown" onclick="toggleMarker(this)">Hypovolemia</button>
    <button class="brown" onclick="toggleMarker(this)">Hydrogen</button>
    <button class="brown" onclick="toggleMarker(this)">Hypo/Hyperkalemia</button>
    <button class="orange" onclick="toggleMarker(this)">Thrombosis/Coronary</button>
    <button class="orange" onclick="toggleMarker(this)">Thrombosis/Pulmonary</button>
    <button class="orange" onclick="toggleMarker(this)">Tamponade</button>
    <button class="orange" onclick="toggleMarker(this)">Toxins</button>
    <button class="orange" onclick="toggleMarker(this)">Tension pneumothorax</button>
  </div>
</div>
  
<!-- ç©ºè¡Œ -->
<div style="height: 20px;"></div>

<!-- Mute -->
<div class="center-row">
  <button id="muteBtn" class="dark" onclick="toggleMute()">Mute</button>
</div>

<!-- ROSC èˆ‡ ISBAR -->
<div class="center-row">
  <button class="blue" onclick="recordEvent('ROSC')">ROSC</button>
  <button class="gray" onclick="showISBAR()">ISBAR</button>
</div>

<!-- Reset -->
<div class="center-row">
  <button class="iron-gray" onclick="resetLog()">Reset</button>
</div>

<!-- ç´€éŒ„å€ -->
<div id="log"></div>

<!-- JavaScript åŠŸèƒ½ -->
<script>
let startTime = null;
let epiCount = 0, amioCount = 0, lidoCount = 0, shockCount = 0;
let timers = [];

function updateClock() {
  const now = new Date();
  document.getElementById("clock").innerText =
    "Current Timeï¼š" + now.toLocaleString('zh-TW', { hour12: false });
}
setInterval(updateClock, 1000); updateClock();

function recordEvent(event) {
  const now = new Date();
  if (!startTime) startTime = now;
  const elapsed = Math.floor((now - startTime) / 1000);
  const timeStamp = `${Math.floor(elapsed / 60).toString().padStart(2, '0')}:${(elapsed % 60).toString().padStart(2, '0')}`;
  const nowTime = now.toLocaleTimeString('zh-TW', { hour12: false });

  const logContainer = document.getElementById("log");
  const logEntry = document.createElement("div");
  logEntry.style.display = "flex";
  logEntry.style.alignItems = "center";
  logEntry.style.justifyContent = "space-between";
  logEntry.style.marginBottom = "4px";

  const logText = document.createElement("span");
  logText.textContent = `[${timeStamp}] [${nowTime}] ${event}`;
  logText.style.flex = "1";

  // âœ… æ ¹æ“š event æ–‡å­—å…§å®¹æ±ºå®šæ¨£å¼
if (/Epinephrine|Amiodarone|Lidocaine/.test(event)) {
  logText.style.backgroundColor = "blue";
  logText.style.color = "white";
  logText.style.fontWeight = "bold";
  logText.style.padding = "2px 6px";
  logText.style.borderRadius = "4px";
} else if (/Shock/.test(event)) {
  logText.style.backgroundColor = "red";
  logText.style.color = "yellow";
  logText.style.fontWeight = "bold";
  logText.style.padding = "2px 6px";
  logText.style.borderRadius = "4px";
} else if (/^(IV|IO|Endo|Endo Fix \d{2} cm)$/.test(event)) {
  logText.style.backgroundColor = "green";
  logText.style.color = "white";
  logText.style.fontWeight = "bold";
  logText.style.padding = "2px 6px";
  logText.style.borderRadius = "4px";
} else if (/ROSC/.test(event)) {
  logText.style.backgroundColor = "#4fc3f7"; // å¤©ç©ºè—
  logText.style.color = "white";
  logText.style.fontWeight = "bold";
  logText.style.padding = "2px 6px";
  logText.style.borderRadius = "4px";
}
  
  const delBtn = document.createElement("button");
  delBtn.textContent = "åˆªé™¤";
  delBtn.style.marginLeft = "10px";
  delBtn.style.backgroundColor = "#f44336";
  delBtn.style.color = "white";
  delBtn.style.border = "none";
  delBtn.style.borderRadius = "4px";
  delBtn.style.cursor = "pointer";
  delBtn.onclick = function () {
    if (confirm("æ˜¯å¦åˆªé™¤ï¼Ÿ")) {
      logContainer.removeChild(logEntry);
    }
  };

  logEntry.appendChild(logText);
  logEntry.appendChild(delBtn);
  logContainer.appendChild(logEntry);
}
let beatInterval = null;


function startCPR() {
  recordEvent("CPR é–‹å§‹");
  if (!startTime) startTime = new Date();

  // æ¯å…©åˆ†é˜æé†’
  timers.push(setInterval(() => alert("æé†’ï¼šCPR åŸ·è¡Œä¸­ï¼Œè«‹è€ƒæ…® 5H5Tï¼Ÿ"), 120000));

  // å…©ç§’å¾Œå•Ÿå‹•ç¯€æ‹å™¨
  setTimeout(() => {
    startBeat();
  }, 2000);
}

function stopCPR() {
  recordEvent("CPR åœæ­¢");
  timers.forEach(t => clearTimeout(t) || clearInterval(t));
  timers = [];
  if (beatInterval) {
    beatInterval = null;
  }
}
function aedAnalyze() {
  stopBeat(); // âœ… æš«åœç¯€æ‹å™¨
  recordEvent("AED åˆ†æé–‹å§‹ï¼ˆå€’æ•¸ 10 ç§’ï¼‰");

  // 10ç§’å¾Œåˆ†æçµæŸï¼Œæ¢å¾©ç¯€æ‹å™¨
  setTimeout(() => {
    recordEvent("AED åˆ†æçµæŸ");
    startBeat(); // âœ… é‡æ–°å•Ÿå‹•ç¯€æ‹å™¨
  }, 10000);

  // é¡å¤–æé†’
  timers.push(setTimeout(() => alert("30ç§’å¾Œå¿ƒå¾‹åˆ†æ"), 90000));
  timers.push(setTimeout(() => alert("10ç§’å¾Œå¿ƒå¾‹åˆ†æ"), 110000));
}

function switchCPR() {
  recordEvent("CPR æ›äºº");
  setTimeout(() => alert("2åˆ†é˜å·²åˆ°ï¼Œè«‹è€ƒæ…® CPR æ›äºº"), 120000);
}
function giveEpinephrine() {
  alert("1mg IVP");
  recordEvent("Epinephrine 1mg çµ¦è—¥");
  document.getElementById("epiCount").innerText = ++epiCount;
}
function giveAmiodarone() {
  if (++amioCount === 1) {
    alert("300mg IVP (è€ƒæ…®Lidocaine?)");
    recordEvent("Amiodarone 300mg çµ¦è—¥");
  } else if (amioCount === 2) {
    alert("150mg IVP");
    recordEvent("Amiodarone 150mg çµ¦è—¥");
    const btn = document.getElementById("amioBtn");
    btn.disabled = true;
    btn.style.opacity = 0.5;
  }
  document.getElementById("amioCount").innerText = amioCount;
}
function giveLidocaine() {
  let dose = null;

  if (lidoCount === 0) {
    dose = prompt("1â€“1.5mg/kg IVP\nè«‹è¼¸å…¥åŠ‘é‡ï¼ˆmgï¼‰ï¼š");
    if (dose) {
      lidoCount++;
      recordEvent(`Lidocaine ${dose}mg çµ¦è—¥`);
    }
  } else if (lidoCount === 1) {
    dose = prompt("0.5â€“0.75mg/kg IVP\nè«‹è¼¸å…¥åŠ‘é‡ï¼ˆmgï¼‰ï¼š", "50");
    if (dose) {
      lidoCount++;
      recordEvent(`Lidocaine ${dose}mg çµ¦è—¥`);

      // ç¬¬äºŒæ¬¡å¾Œåœç”¨æŒ‰éˆ•
      const btn = document.getElementById("lidoBtn");
      btn.disabled = true;
      btn.style.opacity = 0.5;
    }
  }

  document.getElementById("lidoCount").innerText = lidoCount;
}
function recordShock() {
  recordEvent("Shock!");
  document.getElementById("shockCount").innerText = ++shockCount;
}
function recordEndoTube() {
  const cm = prompt("ç¢ºèª Fix\nè«‹è¼¸å…¥æ•¸å€¼ï¼ˆ19-23cmï¼‰æˆ–å–æ¶ˆï¼š");
  if (cm && ["19", "20", "21", "22", "23"].includes(cm)) {
    recordEvent(`Endo Fix ${cm} cm`);
  }
}
function resetLog() {
  if (confirm("ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰ç´€éŒ„ï¼Ÿ")) {
    // æ¸…é™¤ç´€éŒ„å€
    document.getElementById("log").innerHTML = "";

    // æ¸…é™¤è¼¸å…¥æ¬„ä½
    const inputs = document.querySelectorAll("input[type='text'], input[type='number'], textarea");
    inputs.forEach(input => input.value = "");

    // åœæ­¢æ‰€æœ‰è¨ˆæ™‚å™¨
    if (timers && Array.isArray(timers)) {
      timers.forEach(t => clearTimeout(t) || clearInterval(t));
    }
    timers = [];

    // åœæ­¢è²éŸ³
    stopBeepLoop();

    // æ¸…é™¤èµ·å§‹æ™‚é–“
    startTime = null;

    // é‚„åŸæŒ‰éˆ•æ¨£å¼
    const toggleButtons = document.querySelectorAll(".toggled, .selected");
    toggleButtons.forEach(btn => {
      btn.classList.remove("toggled");
      btn.classList.remove("selected");
      btn.disabled = false;
      btn.style.opacity = 1;
    });

    // é‡è¨­ Mute æŒ‰éˆ•æ¨£å¼èˆ‡ç‹€æ…‹
    const muteBtn = document.getElementById("muteBtn");
    if (muteBtn) {
      muteBtn.innerText = "Mute";
      muteBtn.className = "dark";
    }
    isMuted = false;

    // é‡è¨­è—¥ç‰©èˆ‡ shock æ¬¡æ•¸
    epiCount = 0;
    amioCount = 0;
    lidoCount = 0;
    shockCount = 0;
    document.getElementById("epiCount").innerText = "0";
    document.getElementById("amioCount").innerText = "0";
    document.getElementById("lidoCount").innerText = "0";
    document.getElementById("shockCount").innerText = "0";
  }
}

function toggleGender(selected) {
  const maleBtn = document.getElementById("maleBtn");
  const femaleBtn = document.getElementById("femaleBtn");
  if (selected === 'male') {
    maleBtn.classList.toggle('selected');
    femaleBtn.classList.remove('selected');
  } else {
    femaleBtn.classList.toggle('selected');
    maleBtn.classList.remove('selected');
  }
}
function toggleMarker(btn) {
  btn.classList.toggle('toggled');
}
  let isMuted = false;

function toggleMute() {
  const btn = document.getElementById("muteBtn");
  isMuted = !isMuted;
  btn.innerText = isMuted ? "Unmute" : "Mute";
  btn.className = isMuted ? "light" : "dark";
}

function playBeep() {
  if (isMuted) return;
  const beep = document.getElementById("beepSound");
  beep.currentTime = 0;
  beep.play();
}
function startBeepLoop() {
  const beep = document.getElementById("beepSound");
  beep.volume = 1;
  beep.currentTime = 0;
  beep.play();
}

function muteBeep() {
  const beep = document.getElementById("beepSound");
  beep.volume = 0;
}

function unmuteBeep() {
  const beep = document.getElementById("beepSound");
  beep.volume = 1;
}

function stopBeepLoop() {
  const beep = document.getElementById("beepSound");
  beep.pause();
  beep.currentTime = 0;
  beep.volume = 0;
}
function startCPR() {
  recordEvent("CPR é–‹å§‹");
  if (!startTime) startTime = new Date();

  timers.push(setInterval(() => alert("æé†’ï¼šCPR åŸ·è¡Œä¸­ï¼Œè«‹è€ƒæ…® 5H5Tï¼Ÿ"), 120000));

  setTimeout(() => {
    startBeepLoop(); // ğŸ”Š å»¶é² 1 ç§’æ’­æ”¾å¾ªç’°éŸ³æ•ˆ
  }, 1000);
}
function aedAnalyze() {
  muteBeep(); // ğŸ”‡ éœéŸ³æ’­æ”¾éŸ³æ•ˆ
  recordEvent("AED åˆ†æé–‹å§‹ï¼ˆå€’æ•¸ 10 ç§’ï¼‰");

  setTimeout(() => {
    recordEvent("AED åˆ†æçµæŸ");
    unmuteBeep(); // ğŸ”Š æ¢å¾©éŸ³æ•ˆéŸ³é‡
  }, 10000);

  timers.push(setTimeout(() => alert("30ç§’å¾Œå¿ƒå¾‹åˆ†æ"), 90000));
  timers.push(setTimeout(() => alert("10ç§’å¾Œå¿ƒå¾‹åˆ†æ"), 110000));
}
function stopCPR() {
  recordEvent("CPR åœæ­¢");
  timers.forEach(t => clearTimeout(t) || clearInterval(t));
  timers = [];
  stopBeepLoop(); // ğŸ›‘ åœæ­¢éŸ³æ•ˆæ’­æ”¾
}
function showISBAR() {
  const chief = document.getElementById("chiefComplaint")?.value || "ï¼ˆæœªå¡«å¯«ï¼‰";
  const history = document.getElementById("history")?.value || "ï¼ˆæœªå¡«å¯«ï¼‰";
  const age = document.getElementById("ageInput")?.value || "ï¼Ÿ";
  let gender = "ï¼ˆæœªé¸ï¼‰";
  if (document.getElementById("maleBtn").classList.contains("selected")) {
    gender = "ç”·æ€§";
  } else if (document.getElementById("femaleBtn").classList.contains("selected")) {
    gender = "å¥³æ€§";
  }
  const spo2Left = document.querySelector("#spo2Left")?.value || "??";
  const spo2Right = document.querySelector("#spo2Right")?.value || "??";
  const btValue = document.getElementById("btInput")?.value || "æœªå¡«";
  
  let cprStart = null, cprStop = null;
  const logs = document.querySelectorAll("#log div span");
  logs.forEach(span => {
    const text = span.textContent;
    if (text.includes("CPR é–‹å§‹")) cprStart = extractTime(text);
    if (text.includes("CPR åœæ­¢")) cprStop = extractTime(text);
  });

  let cprDuration = "ï¼ˆå°šæœªçµæŸï¼‰";
  if (cprStart && cprStop) {
    const mins = Math.floor((cprStop - cprStart) / 60000);
    cprDuration = `${mins} åˆ†é˜`;
  }

  const medStats = {};
  logs.forEach(span => {
    const text = span.textContent;
    const match = text.match(/\[(\d{2}:\d{2}:\d{2})\] .*?(Epinephrine|Amiodarone|Lidocaine).*?çµ¦è—¥/);
    if (match) {
      const [_, time, name] = match;
      if (!medStats[name]) medStats[name] = { count: 0, last: null };
      medStats[name].count++;
      medStats[name].last = time;
    }
  });

  let meds = "";
  for (const [name, stat] of Object.entries(medStats)) {
    meds += `- ${name} ${stat.count} æ¬¡ï¼Œæœ€å¾Œä¸€æ¬¡çµ¦è—¥æ™‚é–“æ˜¯ ${stat.last}\n`;
  }

  const isbar = `
ã€ISBAR å½™æ•´ã€‘
Iï¼š
é†«å¸«å¥½ï¼Œæˆ‘æ˜¯ç½²P91ã€‚

Sï¼š
${gender}æ‚£è€… ${age} æ­²ï¼Œ${chief}ï¼ŒSpOâ‚‚ ${spo2Left}â†’${spo2Right}%ï¼ŒCPR å·²æŒçºŒ ${cprDuration}ã€‚

Bï¼š
éå»ç—…å²æœ‰ ${history}ã€‚

Aï¼š
å¿ƒé›»åœ–è«‹è‡ªè¡Œåˆ¤è®€ã€‚
å·²çµ¦äºˆè—¥ç‰©ï¼š
${meds.trim()}

Rï¼š
å»ºè­°ï¼šè«‹è‡ªè¡Œè©•ä¼°ã€‚
  `;
  alert(isbar);
}

function extractTime(text) {
  const match = text.match(/\[(\d{2}:\d{2}:\d{2})\]/);
  return match ? new Date("1970-01-01T" + match[1] + "Z") : null;
}
</script>

</body>
</html>
