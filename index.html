<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ACLS Timer Tool</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      margin: 0; padding: 20px;
      display: flex; flex-direction: column; align-items: center;
      background-color: #2f2f2f; /* éµç°èƒŒæ™¯ */
      position: relative;
    }
    .center-row {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 15px;
      gap: 10px;
      width: 100%;
    }
    .split-row {
      display: flex;
      justify-content: center;
      gap: 40px;
      width: 100%;
    }
    .column {
      width: 45%;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }
    button {
      padding: 6px 10px;
      font-size: 13px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      width: 100%;
      max-width: 160px;
    }
    #logo-overlay {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) rotate(90deg);
      opacity: 0.5;
      z-index: 0;
      height: 150px; /* å¯è¦–éœ€æ±‚èª¿æ•´åœ–ç‰‡å¤§å° */
      pointer-events: none;
    }
    .selected { background-color: black !important; color: white !important; }
    .iron-gray { background-color: #4e4e4e; /* éµç°è‰² */
                 color: white; border: none; border-radius: 6px; padding: 6px 12px; }
    .red { background-color: #e53935; color: white; }
    .darkred { background-color: #8B0000; color: white; }
    .yellow { background-color: #fbc02d; color: black; }
    .green { background-color: #40e0d0; color: black; }
    .blue { background-color: #4fc3f7; color: black; }
    .gray { background-color: #b0bec5; color: black; }
    .shoke { background-color: #e53935; color: yellow; font-weight: bold; }
    .brown { background-color: #d2b48c; color: black; }
    .orange { background-color: orange; color: black; }
    .dark { background-color: black; color: white; }
    .light { background-color: white; color: black; border: 1px solid #333; }
    .toggled { background-color: #555 !important; color: white !important; text-decoration: line-through; }
    .input-label { font-size: 16px; margin-left: 10px; }
    #log {
      margin-top: 20px;
      white-space: pre-line;
      border-top: 1px solid #ccc;
      padding-top: 10px;
      width: 100%;
      max-width: 1000px;
      text-align: left;
    }
    #countInfo, #clock {
      font-size: 18px;
      color: #ffffff; /* ç™½å­—æ›´æ¸…æ¥š */
    }
    .header-text {
      font-size: 24px;
      background-color: #e53935;
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      text-align: center;
    }
    
  </style>
</head>
<img src="logo.PNG" id="logo-overlay" />
<body>

<div id="toast" style="position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
background-color: rgba(0, 0, 0, 0.7); color: yellow; padding: 10px 20px; border-radius: 6px;
opacity: 0; transition: opacity 0.5s; z-index: 9999; pointer-events: none; font-size: 24px;">
</div>

<audio id="beepSound" src="beep_logic110_1.mp3" loop></audio>
  
<!-- æ¨™é¡Œèˆ‡æ™‚é–“ -->
<div class="center-row"><div class="header-text">ACLS Timer Tool</div></div>
<div class="center-row"><div id="clock"></div></div>

<!-- æ€§åˆ¥èˆ‡å¹´é½¡ -->
<div class="center-row">
  <button class="gray" id="maleBtn" onclick="toggleGender('male')">Male</button>
  <button class="gray" id="femaleBtn" onclick="toggleGender('female')">Female</button>
  <input type="number" id="ageInput" style="width: 6ch; padding: 2px 4px; margin-right: 2px;" />
  <span style="font-size: 16px;">Y</span>
</div>

<!-- çµ¦è—¥èˆ‡è™•ç½®ç´€éŒ„å€å¡Š -->
<div class="split-row">
<!-- å·¦é‚Šæ¬„ä½ -->
<div class="column" style="align-items: flex-start;">
  <div><strong>Epinephrine:</strong> <span id="epiCount">0</span></div>
  <div><strong>Amiodarone:</strong> <span id="amioCount">0</span></div>
  <div><strong>Lidocaine:</strong> <span id="lidoCount">0</span></div>
  <div><strong>Shock:</strong> <span id="shockCount">0</span></div>
<!-- RR èˆ‡ HR åŒåˆ—æ’åˆ— -->
<div style="display: flex; align-items: center; gap: 12px; margin-top: 12px;">
  <div style="display: flex; align-items: center;">
    <strong style="margin-right: 6px;">RR</strong>
    <input type="text" id="rrInput" style="width: 35px;" />
  </div>
  <div style="display: flex; align-items: center;">
    <strong style="margin-right: 6px;">HR</strong>
    <input type="text" id="hrInput" style="width: 35px;" />
  </div>
</div>

<!-- BP åŒä¸€åˆ— -->
<div style="display: flex; align-items: center; margin-top: 12px;">
  <strong style="margin-right: 8px;">BP</strong>
  <input type="text" id="bpSysInput" style="width: 35px; margin-right: 4px;" />
  <span>/</span>
  <input type="text" id="bpDiaInput" style="width: 35px; margin-left: 4px;" />
</div>
  
  <!-- SpO2 æ”¹ç‚ºç²—é«”ä¸¦æ›è¡Œé¡¯ç¤ºè¼¸å…¥æ¡†èˆ‡ % -->
  <div style="display: flex; align-items: center; gap: 6px; margin-top: 4px;">
  <strong style="margin-right: 8px;">SpOâ‚‚</strong>
  <input type="text" id="spo2Left" style="width: 35px;" />
  <span>â†’</span>
  <input type="text" id="spo2Right" style="width: 35px;" />
  <span>%</span>
</div>

  <!-- BT æ”¹ç‚ºç²—é«”ä¸”èˆ‡è¼¸å…¥æ¡†åŒè¡Œï¼Œé¡¯ç¤ºåº¦C -->
  <div style="display: flex; align-items: center; margin-top: 12px;">
    <strong style="font-size: 16px; margin-right: 8px;">BT</strong>
    <input type="text" id="btInput" style="width: 40px; margin-right: 6px;" />
    <span>Â°C</span>
  </div>

  <!-- ç©ºç™½å€éš” -->
  <div style="height: 20px;"></div>
</div>
  <!-- å³é‚Šæ¬„ä½ -->
  <div class="column" style="align-items: flex-start;">
    <label for="chiefComplaint" style="font-weight: bold; font-size: 14px; margin-bottom: 5px;">ä¸»è¨´</label>
    <textarea id="chiefComplaint" rows="1" style="width: 100%; font-size: 14px; padding: 6px;"></textarea>
    
    <label for="history" style="font-weight: bold; font-size: 14px; margin-bottom: 5px;">ç—…å²/éæ•å²</label>
    <textarea id="history" rows="1" style="width: 100%; font-size: 14px; padding: 6px;"></textarea>

    <label for="otherNotes" style="font-weight: bold; font-size: 14px; margin-top: 10px; margin-bottom: 5px;">å…¶ä»–è™•ç½®/èªªæ˜</label>
    <textarea id="otherNotes" rows="1" style="width: 100%; font-size: 14px; padding: 6px;"></textarea>
  </div>
</div>
<div style="height: 20px;"></div>

<!-- æ“ä½œæŒ‰éˆ•èˆ‡5H5T -->
<div class="split-row">
  <div class="column">
    <button class="red" onclick="startCPR()">CPR</button>
    <button class="red" onclick="aedAnalyze()">AED Analyze</button>
    <button class="red" onclick="switchCPR()">Switch CPR</button>
    <button class="shoke" onclick="recordShock()">âš¡ï¸âš¡ï¸Shockâš¡ï¸âš¡ï¸</button>
    <button class="darkred" onclick="stopCPR()">Stop CPR</button>
    <button class="yellow" onclick="giveEpinephrine()">Epinephrine</button>
    <button class="yellow" id="amioBtn" onclick="giveAmiodarone()">Amiodarone</button>
    <button class="yellow" id="lidoBtn" onclick="giveLidocaine()">Lidocaine</button>
    <button class="green" onclick="recordEvent('IV')">I.V.</button>
    <button class="green" onclick="recordEvent('IO')">I.O.</button>
    <button class="green" onclick="recordEndoTube()">Endo</button>
  </div>
  <div class="column">
    <button class="brown" onclick="toggleMarker(this)">ä½é«”æº«</button>
    <button class="brown" onclick="toggleMarker(this)">ç¼ºæ°§</button>
    <button class="brown" onclick="toggleMarker(this)">ä½è¡€å®¹</button>
    <button class="brown" onclick="toggleMarker(this)">é…¸é¹¼å•é¡Œ</button>
    <button class="brown" onclick="toggleMarker(this)">é«˜ä½è¡€é‰€</button>
    <button class="orange" onclick="toggleMarker(this)">å† ç‹€å‹•è„ˆè¡€æ “</button>
    <button class="orange" onclick="toggleMarker(this)">è‚ºå‹•è„ˆæ “å¡</button>
    <button class="orange" onclick="toggleMarker(this)">ä¸­æ¯’</button>
    <button class="orange" onclick="toggleMarker(this)">å¼µåŠ›æ€§æ°£èƒ¸</button>
    <button class="orange" onclick="toggleMarker(this)">å¿ƒåŒ…è†œå¡«å¡</button>
  </div>
</div>
  
<!-- ç©ºè¡Œ -->
<div style="height: 20px;"></div>

<!-- ROSC èˆ‡ ISBAR -->
<div class="center-row">
  <button class="blue" onclick="recordEvent('ROSC')">ROSC</button>
  <button class="gray" onclick="showISBAR()">ISBAR</button>
</div>

<!-- Reset -->
<div class="center-row">
  <button class="iron-gray" onclick="resetLog()">Reset</button>
</div>

<!-- ç´€éŒ„å€ -->
<div id="log"></div>

<!-- é€™æ˜¯ Endo çš„è‡ªè¨‚å½ˆå‡ºè¦–çª— -->
<div id="endoModal" style="display: none; position: fixed; top: 30%; left: 50%; transform: translateX(-50%);
background-color: white; border: 2px solid #999; border-radius: 8px; padding: 20px; z-index: 9999; text-align: center;">
  <p style="margin-bottom: 10px; font-weight: bold;">è«‹é¸æ“‡ Fix é•·åº¦ï¼š</p>
  <div style="display: flex; gap: 10px; justify-content: center;">
    <button onclick="selectEndoFix(19)">19</button>
    <button onclick="selectEndoFix(20)">20</button>
    <button onclick="selectEndoFix(21)">21</button>
    <button onclick="selectEndoFix(22)">22</button>
    <button onclick="selectEndoFix(23)">23</button>
  </div>
</div>

<!-- JavaScript åŠŸèƒ½ -->
<script>
let startTime = null;
let epiCount = 0, amioCount = 0, lidoCount = 0, shockCount = 0;
let timers = [];
let endoFixCm = null;

function showToast(message) {
  const toast = document.getElementById("toast");
  toast.innerText = message;
  toast.style.opacity = "1";

  setTimeout(() => {
    toast.style.opacity = "0";
  }, 2000); // 2 ç§’å¾Œæ·¡å‡º
}

function updateClock() {
  const now = new Date();
  document.getElementById("clock").innerText =
    "Current Timeï¼š" + now.toLocaleString('zh-TW', { hour12: false });
}
setInterval(updateClock, 1000); updateClock();

function recordEvent(event) {
  const now = new Date();
  if (!startTime) startTime = now;
  const elapsed = Math.floor((now - startTime) / 1000);
  const timeStamp = `${Math.floor(elapsed / 60).toString().padStart(2, '0')}:${(elapsed % 60).toString().padStart(2, '0')}`;
  const nowTime = now.toLocaleTimeString('zh-TW', { hour12: false });

  const logContainer = document.getElementById("log");
  const logEntry = document.createElement("div");
  logEntry.style.display = "flex";
  logEntry.style.alignItems = "center";
  logEntry.style.justifyContent = "space-between";
  logEntry.style.marginBottom = "4px";

  const logText = document.createElement("span");
  logText.textContent = `[${timeStamp}] [${nowTime}] ${event}`;
  logText.style.flex = "1";

  // âœ… æ ¹æ“š event æ–‡å­—å…§å®¹æ±ºå®šæ¨£å¼
if (/Epinephrine|Amiodarone|Lidocaine/.test(event)) {
  logText.style.backgroundColor = "blue";
  logText.style.color = "white";
  logText.style.fontWeight = "bold";
  logText.style.padding = "2px 6px";
  logText.style.borderRadius = "4px";
} else if (/Shock/.test(event)) {
  logText.style.backgroundColor = "red";
  logText.style.color = "yellow";
  logText.style.fontWeight = "bold";
  logText.style.padding = "2px 6px";
  logText.style.borderRadius = "4px";
} else if (/^(IV|IO|Endo|Endo Fix \d{2} cm)$/.test(event)) {
  logText.style.backgroundColor = "green";
  logText.style.color = "white";
  logText.style.fontWeight = "bold";
  logText.style.padding = "2px 6px";
  logText.style.borderRadius = "4px";
} else if (/ROSC/.test(event)) {
  logText.style.backgroundColor = "#4fc3f7"; // å¤©ç©ºè—
  logText.style.color = "white";
  logText.style.fontWeight = "bold";
  logText.style.padding = "2px 6px";
  logText.style.borderRadius = "4px";
}
  
  const delBtn = document.createElement("button");
  delBtn.textContent = "åˆªé™¤";
  delBtn.style.marginLeft = "10px";
  delBtn.style.backgroundColor = "#f44336";
  delBtn.style.color = "white";
  delBtn.style.border = "none";
  delBtn.style.borderRadius = "4px";
  delBtn.style.cursor = "pointer";
  delBtn.onclick = function () {
  if (confirm("æ˜¯å¦åˆªé™¤ï¼Ÿ")) {
    const text = logText.textContent;

    // æª¢æŸ¥åˆªé™¤çš„æ˜¯å“ªå€‹è—¥ç‰©ç´€éŒ„
    if (text.includes("Amiodarone")) {
      amioCount = Math.max(0, amioCount - 1);
      document.getElementById("amioCount").innerText = amioCount;
      const btn = document.getElementById("amioBtn");
      btn.disabled = amioCount >= 2;
      btn.style.opacity = btn.disabled ? 0.5 : 1;
    }

    if (text.includes("Lidocaine")) {
      lidoCount = Math.max(0, lidoCount - 1);
      document.getElementById("lidoCount").innerText = lidoCount;
      const btn = document.getElementById("lidoBtn");
      btn.disabled = lidoCount >= 2;
      btn.style.opacity = btn.disabled ? 0.5 : 1;
    }

    logContainer.removeChild(logEntry);  // âœ… æ­£ç¢ºç§»é™¤ç´€éŒ„
    updateCountsFromLog();               // âœ… åŒæ­¥æ›´æ–°è¨ˆæ•¸
  }
};

  logEntry.appendChild(logText);
  logEntry.appendChild(delBtn);
  logContainer.appendChild(logEntry);
  showToast(event);  // âœ… é¡¯ç¤ºè¨Šæ¯
}
let beatInterval = null;

function aedAnalyze() {
  recordEvent("AED åˆ†æä¸­â€¦â€¦");
  showToast("AED 10ç§’åˆ†æä¸­â€¦â€¦");

  setTimeout(() => {
    recordEvent("AED åˆ†æå®Œç•¢");
    showToast("AED åˆ†æå®Œç•¢");

    // å®‰æ’æç¤º
    timers.push(setTimeout(() => alert("ğŸ”” 30ç§’å¾Œåˆ†æå¿ƒå¾‹"), 90000));
    timers.push(setTimeout(() => alert("ğŸ”” 10ç§’å¾Œåˆ†æå¿ƒå¾‹"), 110000));
  }, 10000);
}

function switchCPR() {
  recordEvent("CPR æ›äºº");
  setTimeout(() => alert("2åˆ†é˜å·²åˆ°ï¼Œè«‹è€ƒæ…® CPR æ›äºº"), 120000);
}
function giveEpinephrine() {
  alert("1mg IVP");
  recordEvent("Epinephrine 1mg çµ¦è—¥");
  document.getElementById("epiCount").innerText = ++epiCount;
  updateCountsFromLog();
}
function giveAmiodarone() {
  if (++amioCount === 1) {
    alert("300mg IVP (è€ƒæ…®Lidocaine?)");
    recordEvent("Amiodarone 300mg çµ¦è—¥");
    updateCountsFromLog();  // âœ… åŠ åœ¨é€™è£¡
  } else if (amioCount === 2) {
    alert("150mg IVP");
    recordEvent("Amiodarone 150mg çµ¦è—¥");
    updateCountsFromLog();  // âœ… åŠ åœ¨é€™è£¡
    const btn = document.getElementById("amioBtn");
    btn.disabled = true;
    btn.style.opacity = 0.5;
  }
  document.getElementById("amioCount").innerText = amioCount;
}
  
function giveLidocaine() {
  if (++lidoCount === 1) {
    alert("1-1.5mg/kg IVP");
    recordEvent("Lidocaine åŠ‘é‡(?)mg");
    updateCountsFromLog();  // âœ… åŠ åœ¨é€™
  } else if (lidoCount === 2) {
    alert("0.5-0.75mg/kg IVP");
    recordEvent("Lidocaine åŠ‘é‡(?)mg");
    updateCountsFromLog();  // âœ… åŠ åœ¨é€™
    const btn = document.getElementById("lidoBtn");
    btn.disabled = true;
    btn.style.opacity = 0.5;
  }
  document.getElementById("lidoCount").innerText = lidoCount;
}

function recordShock() {
  recordEvent("Shock!");
  document.getElementById("shockCount").innerText = ++shockCount;
  updateCountsFromLog();
}
function recordEndoTube() {
  document.getElementById("endoModal").style.display = "block";
}

function selectEndoFix(cm) {
  endoFixCm = cm;
  recordEvent(`Endo Fix ${cm} cm`);
  document.getElementById("endoModal").style.display = "none";
}

function resetLog() {
  if (confirm("ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰ç´€éŒ„ï¼Ÿ")) {
    // æ¸…é™¤ç´€éŒ„å€
    document.getElementById("log").innerHTML = "";

    // æ¸…é™¤è¼¸å…¥æ¬„ä½
    const inputs = document.querySelectorAll("input[type='text'], input[type='number'], textarea");
    inputs.forEach(input => input.value = "");

    // åœæ­¢æ‰€æœ‰è¨ˆæ™‚å™¨
    if (timers && Array.isArray(timers)) {
      timers.forEach(t => clearTimeout(t) || clearInterval(t));
    }
    timers = [];

    // åœæ­¢è²éŸ³
    stopBeepLoop();

    // æ¸…é™¤èµ·å§‹æ™‚é–“
    startTime = null;

    // é‚„åŸæŒ‰éˆ•æ¨£å¼
    const toggleButtons = document.querySelectorAll(".toggled, .selected");
    toggleButtons.forEach(btn => {
      btn.classList.remove("toggled");
      btn.classList.remove("selected");
      btn.disabled = false;
      btn.style.opacity = 1;
    });

    // é‡è¨­ Mute æŒ‰éˆ•æ¨£å¼èˆ‡ç‹€æ…‹
    const muteBtn = document.getElementById("muteBtn");
    if (muteBtn) {
      muteBtn.innerText = "Mute";
      muteBtn.className = "dark";
    }
    isMuted = false;

    // é‡è¨­è—¥ç‰©èˆ‡ shock æ¬¡æ•¸
    epiCount = 0;
    amioCount = 0;
    lidoCount = 0;
    shockCount = 0;
    document.getElementById("epiCount").innerText = "0";
    document.getElementById("amioCount").innerText = "0";
    document.getElementById("lidoCount").innerText = "0";
    document.getElementById("shockCount").innerText = "0";
  }
}

function updateCountsFromLog() {
  const logs = document.querySelectorAll("#log div span");
  let epi = 0, amio = 0, lido = 0, shock = 0;

  logs.forEach(span => {
    const text = span.textContent;
    if (text.includes("Epinephrine")) epi++;
    if (text.includes("Amiodarone")) amio++;
    if (text.includes("Lidocaine")) lido++;
    if (text.includes("Shock!")) shock++;
  });

  epiCount = epi;
  amioCount = amio;
  lidoCount = lido;
  shockCount = shock;

  document.getElementById("epiCount").innerText = epiCount;
  document.getElementById("amioCount").innerText = amioCount;
  document.getElementById("lidoCount").innerText = lidoCount;
  document.getElementById("shockCount").innerText = shockCount;

  const amioBtn = document.getElementById("amioBtn");
  const lidoBtn = document.getElementById("lidoBtn");

  if (amioBtn) {
    amioBtn.disabled = amioCount >= 2;
    amioBtn.style.opacity = amioBtn.disabled ? 0.5 : 1;
  }
  if (lidoBtn) {
    lidoBtn.disabled = lidoCount >= 2;
    lidoBtn.style.opacity = lidoBtn.disabled ? 0.5 : 1;
  }
}

function toggleGender(selected) {
  const maleBtn = document.getElementById("maleBtn");
  const femaleBtn = document.getElementById("femaleBtn");
  if (selected === 'male') {
    maleBtn.classList.toggle('selected');
    femaleBtn.classList.remove('selected');
  } else {
    femaleBtn.classList.toggle('selected');
    maleBtn.classList.remove('selected');
  }
}
function toggleMarker(btn) {
  btn.classList.toggle('toggled');
}


function playBeep() {
  const beep = document.getElementById("beepSound");
  beep.currentTime = 0;
  beep.play();
}
  
function startBeepLoop() {
  const beep = document.getElementById("beepSound");
  beep.volume = 1;
  beep.currentTime = 0;
  beep.play();
}


function stopBeepLoop() {
  const beep = document.getElementById("beepSound");
  beep.pause();
  beep.currentTime = 0;
  beep.volume = 0;
}
function startCPR() {
  recordEvent("CPR é–‹å§‹");
  if (!startTime) startTime = new Date();

  timers.push(setInterval(() => alert("æé†’ï¼šCPR åŸ·è¡Œä¸­ï¼Œè«‹è€ƒæ…® 5H5Tï¼Ÿ"), 120000));

  setTimeout(() => {
    startBeepLoop(); // ğŸ”Š å»¶é² 1 ç§’æ’­æ”¾å¾ªç’°éŸ³æ•ˆ
  }, 1000);
}


function stopCPR() {
  recordEvent("CPR åœæ­¢");
  timers.forEach(t => clearTimeout(t) || clearInterval(t));
  timers = [];
  stopBeepLoop(); // ğŸ›‘ åœæ­¢éŸ³æ•ˆæ’­æ”¾
}
function showISBAR() {
  const chief = document.getElementById("chiefComplaint")?.value || "ï¼ˆæœªå¡«å¯«ï¼‰";
  const history = document.getElementById("history")?.value || "ï¼ˆæœªå¡«å¯«ï¼‰";
  const otherNotes = document.getElementById("otherNotes")?.value || "ï¼ˆæœªå¡«å¯«ï¼‰";
  const age = document.getElementById("ageInput")?.value || "ï¼Ÿ";
  let gender = "ï¼ˆæœªé¸ï¼‰";
  if (document.getElementById("maleBtn").classList.contains("selected")) {
    gender = "ç”·æ€§";
  } else if (document.getElementById("femaleBtn").classList.contains("selected")) {
    gender = "å¥³æ€§";
  }
  const spo2Left = document.querySelector("#spo2Left")?.value || "??";
  const spo2Right = document.querySelector("#spo2Right")?.value || "??";
  const btValue = document.getElementById("btInput")?.value || "??";
  const rrValue = document.getElementById("rrInput")?.value || "æœªå¡«";
  const hrValue = document.getElementById("hrInput")?.value || "æœªå¡«";
  const bpSys = document.getElementById("bpSysInput")?.value || "??";
  const bpDia = document.getElementById("bpDiaInput")?.value || "??";


  let cprStart = null, cprStop = null;
  const logs = document.querySelectorAll("#log div span");
  logs.forEach(span => {
    const text = span.textContent;
    if (text.includes("CPR é–‹å§‹")) cprStart = extractTime(text);
    if (text.includes("CPR åœæ­¢")) cprStop = extractTime(text);
  });
  let roscTime = "å°šç„¡ç´€éŒ„";
  for (let i = 0; i < logs.length; i++) {
    const text = logs[i].textContent;
    if (text.includes("ROSC")) {
      const match = text.match(/\[(\d{2}:\d{2}:\d{2})\]/);  // æŠ“ current time
      if (match) {
        roscTime = match[1];
      }
      break;
  }
}
  let cprDuration = "ï¼ˆå°šæœªçµæŸï¼‰";
  if (cprStart && cprStop) {
    const mins = Math.floor((cprStop - cprStart) / 60000);
    cprDuration = `${mins} åˆ†é˜`;
  }

  const medStats = {};
  logs.forEach(span => {
    const text = span.textContent;
    const match = text.match(/\[(\d{2}:\d{2}:\d{2})\] .*?(Epinephrine|Amiodarone|Lidocaine).*?çµ¦è—¥/);
    if (match) {
      const [_, time, name] = match;
      if (!medStats[name]) medStats[name] = { count: 0, last: null };
      medStats[name].count++;
      medStats[name].last = time;
    }
  });

  let lastMedLine = "";
for (let i = logs.length - 1; i >= 0; i--) {
  const text = logs[i].textContent;
  if (/çµ¦è—¥/.test(text)) {
    const match = text.match(/(Epinephrine|Amiodarone|Lidocaine).*?çµ¦è—¥.*?/);
    if (match) {
      const med = match[1];
      const dose = text.split("çµ¦è—¥")[0].split(med)[1].trim();
      const currentTime = new Date().toLocaleTimeString('zh-TW', { hour12: false });
      lastMedLine = `${currentTime} ${med}${dose ? " " + dose : ""}`;
      break;
    }
  }
}

  let endoInfo = "å°šç„¡ç´€éŒ„";
for (let i = logs.length - 1; i >= 0; i--) {
  const text = logs[i].textContent;
  const match = text.match(/Fix (\d{2})cm/);
  if (match) {
    endoInfo = `Fix ${match[1]}cm`;
    break;
  }
}
 const aText = `A:
 (å¿ƒé›»åœ–è‡ªè¡Œåˆ¤æ–·)
 çµ¦äºˆè—¥ç‰©
 Epinephrineï¼š${medStats.Epinephrine?.count || 0} æ¬¡
 Amiodaroneï¼š${medStats.Amiodarone?.count || 0} æ¬¡
 Lidocaineï¼š${medStats.Lidocaine?.count || 0} æ¬¡

 Shock æ¬¡æ•¸ï¼š${document.getElementById("shockCount").innerText} æ¬¡

 Endo(è™Ÿæ•¸)ï¼š${endoFixCm ? endoFixCm + " cm" : "??"}
 
 æœ€å¾Œä¸€æ¬¡çµ¦è—¥
 ${lastMedLine || "??"}

 å…¶ä»–è™•ç½®/è—¥ç‰©ï¼š${otherNotes}
 `;

  const isbar = `
ã€ISBAR å½™æ•´ã€‘
Iï¼š
é†«å¸«å¥½ï¼Œæˆ‘æ˜¯ç½²P91ã€‚

Sï¼š
${gender}æ‚£è€… ${age} æ­²ï¼Œ${chief}ï¼ŒRR ${rrValue}ï¼ŒHR ${hrValue}ï¼ŒBP ${bpSys}/${bpDia}ï¼ŒSpOâ‚‚ ${spo2Left}â†’${spo2Right}%ï¼ŒCPR å·²æŒçºŒ ${cprDuration}ï¼ŒROSC æ™‚é–“ï¼š${roscTime}
ã€‚

Bï¼š
ç—…å²/éæ•å²ï¼š ${history}ã€‚

${aText}

Rï¼š
å»ºè­°ï¼šè«‹è‡ªè¡Œè©•ä¼°ã€‚
  `;
  // å–å¾—ä¸‹æ–¹ log æ‰€æœ‰ç´€éŒ„å…§å®¹
const logText = Array.from(document.querySelectorAll("#log div span"))
  .map(span => span.textContent)
  .join("\n");

// åˆä½µ ISBAR èˆ‡è™•ç½®ç´€éŒ„
const fullText = `${isbar}\n\nã€è™•ç½®ç´€éŒ„ã€‘\n${logText}`;

// è¤‡è£½æ•´åˆå¾Œæ–‡å­—
navigator.clipboard.writeText(fullText);

// åƒ…å½ˆå‡º ISBAR æœ¬é«”
alert(isbar);
}

function extractTime(text) {
  const match = text.match(/\[(\d{2}:\d{2}:\d{2})\]/);
  return match ? new Date("1970-01-01T" + match[1] + "Z") : null;
}
</script>



</body>
</html>
