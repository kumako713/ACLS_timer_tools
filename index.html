<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ACLS Timer Tool</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      margin: 0; padding: 20px;
      display: flex; flex-direction: column; align-items: center;
    }
    .center-row {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 15px;
      gap: 10px;
      width: 100%;
    }
    .split-row {
      display: flex;
      justify-content: center;
      gap: 40px;
      width: 100%;
    }
    .column {
      width: 45%;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }
    button {
      padding: 6px 10px;
      font-size: 13px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      width: 100%;
      max-width: 160px;
    }
    .selected { background-color: black !important; color: white !important; }
    .red { background-color: #e53935; color: white; }
    .darkred { background-color: #8B0000; color: white; }
    .yellow { background-color: #fbc02d; color: black; }
    .green { background-color: #40e0d0; color: black; }
    .blue { background-color: #4fc3f7; color: black; }
    .gray { background-color: #b0bec5; color: black; }
    .shoke { background-color: #e53935; color: yellow; font-weight: bold; }
    .brown { background-color: #d2b48c; color: black; }
    .orange { background-color: orange; color: black; }
    .dark { background-color: black; color: white; }
    .light { background-color: white; color: black; border: 1px solid #333; }
    .toggled { background-color: #555 !important; color: white !important; text-decoration: line-through; }
    .input-label { font-size: 16px; margin-left: 10px; }
    #log {
      margin-top: 20px;
      white-space: pre-line;
      border-top: 1px solid #ccc;
      padding-top: 10px;
      width: 100%;
      max-width: 1000px;
      text-align: left;
    }
    #countInfo, #clock {
      font-size: 18px;
      color: #333;
    }
    .header-text {
      font-size: 32px;
      background-color: #e53935;
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      text-align: center;
    }
  </style>
</head>
<body>
<audio id="beepSound" src="beep-07a.mp3"></audio>
  
<!-- 標題與時間 -->
<div class="center-row"><div class="header-text">ACLS Timer Tool</div></div>
<div class="center-row"><div id="clock"></div></div>

<!-- 性別與年齡 -->
<div class="center-row">
  <button class="gray" id="maleBtn" onclick="toggleGender('male')">Male</button>
  <button class="gray" id="femaleBtn" onclick="toggleGender('female')">Female</button>
  <input type="number" id="ageInput" style="width: 4ch; padding: 2px 4px; margin-right: 2px;" />
  <span style="font-size: 16px;">Y</span>
</div>

<!-- 給藥與處置紀錄區塊 -->
<div class="split-row">
<!-- 左邊欄位 -->
<div class="column" style="align-items: flex-start;">
  <div><strong>Epinephrine:</strong> <span id="epiCount">0</span></div>
  <div><strong>Amiodarone:</strong> <span id="amioCount">0</span></div>
  <div><strong>Lidocaine:</strong> <span id="lidoCount">0</span></div>
  <div><strong>Shock:</strong> <span id="shockCount">0</span></div>

  <!-- SpO2 改為粗體並換行顯示輸入框與 % -->
  <div style="margin-top: 12px;"><strong>SpO₂</strong></div>
  <div style="display: flex; align-items: center; margin-top: 4px;">
    <input type="text" style="width: 60px; margin-right: 6px;" />
    <span style="margin: 0 6px;">→</span>
    <input type="text" style="width: 60px; margin-right: 6px;" />
    <span>%</span>
  </div>

  <!-- BT 改為粗體且與輸入框同行，顯示度C -->
  <div style="display: flex; align-items: center; margin-top: 12px;">
    <strong style="margin-right: 8px;">BT</strong>
    <input type="text" style="width: 60px; margin-right: 6px;" />
    <span>°C</span>
  </div>

  <!-- 空白區隔 -->
  <div style="height: 20px;"></div>
</div>
  <!-- 右邊欄位 -->
  <div class="column" style="align-items: flex-start;">
    <label for="history" style="font-weight: bold; margin-bottom: 5px;">History/ Allergy</label>
    <textarea id="history" rows="3" style="width: 100%; font-size: 14px; padding: 6px;"></textarea>

    <label for="otherNotes" style="font-weight: bold; margin-top: 10px; margin-bottom: 5px;">Other Treatments</label>
    <textarea id="otherNotes" rows="3" style="width: 100%; font-size: 14px; padding: 6px;"></textarea>
  </div>
</div>
<div style="height: 20px;"></div>

<!-- 操作按鈕與5H5T -->
<div class="split-row">
  <div class="column">
    <button class="red" onclick="startCPR()">CPR</button>
    <button class="red" onclick="aedAnalyze()">AED Analyze</button>
    <button class="red" onclick="switchCPR()">Switch CPR</button>
    <button class="shoke" onclick="recordShock()">⚡️⚡️Shock⚡️⚡️</button>
    <button class="darkred" onclick="stopCPR()">Stop CPR</button>
    <button class="yellow" onclick="giveEpinephrine()">Epinephrine</button>
    <button class="yellow" id="amioBtn" onclick="giveAmiodarone()">Amiodarone</button>
    <button class="yellow" id="lidoBtn" onclick="giveLidocaine()">Lidocaine</button>
    <button class="green" onclick="recordEvent('IV')">I.V.</button>
    <button class="green" onclick="recordEvent('IO')">I.O.</button>
    <button class="green" onclick="recordEndoTube()">Endo</button>
  </div>
  <div class="column">
    <button class="brown" onclick="toggleMarker(this)">Hypothermia</button>
    <button class="brown" onclick="toggleMarker(this)">Hypoxia</button>
    <button class="brown" onclick="toggleMarker(this)">Hypovolemia</button>
    <button class="brown" onclick="toggleMarker(this)">Hydrogen</button>
    <button class="brown" onclick="toggleMarker(this)">Hypo/Hyperkalemia</button>
    <button class="orange" onclick="toggleMarker(this)">Thrombosis/Coronary</button>
    <button class="orange" onclick="toggleMarker(this)">Thrombosis/Pulmonary</button>
    <button class="orange" onclick="toggleMarker(this)">Tamponade</button>
    <button class="orange" onclick="toggleMarker(this)">Toxins</button>
    <button class="orange" onclick="toggleMarker(this)">Tension pneumothorax</button>
  </div>
</div>

<!-- 空一列區隔 + Mute 按鈕 + ROSC/Reset -->
<div class="center-row" style="height: 20px;"></div>

<div class="center-row">
  <button id="muteBtn" class="dark" onclick="toggleMute()">Mute</button>
</div>

<div class="center-row">
  <div style="width: 45%; display: flex; justify-content: center;">
    <button class="blue" onclick="recordEvent('ROSC')">ROSC</button>
  </div>
  <div style="width: 45%; display: flex; justify-content: center;">
    <button class="gray" onclick="resetLog()">Reset</button>
  </div>
</div>

<!-- 紀錄區 -->
<div id="log"></div>

<!-- JavaScript 功能 -->
<script>
let startTime = null;
let epiCount = 0, amioCount = 0, lidoCount = 0, shockCount = 0;
let timers = [];

function updateClock() {
  const now = new Date();
  document.getElementById("clock").innerText =
    "Current Time：" + now.toLocaleString('zh-TW', { hour12: false });
}
setInterval(updateClock, 1000); updateClock();

function recordEvent(event) {
  const now = new Date();
  if (!startTime) startTime = now;
  const elapsed = Math.floor((now - startTime) / 1000);
  const timeStamp = `${Math.floor(elapsed / 60).toString().padStart(2, '0')}:${(elapsed % 60).toString().padStart(2, '0')}`;
  const nowTime = now.toLocaleTimeString('zh-TW', { hour12: false });

  const logContainer = document.getElementById("log");

  const logEntry = document.createElement("div");
  logEntry.style.display = "flex";
  logEntry.style.alignItems = "center";
  logEntry.style.justifyContent = "space-between";
  logEntry.style.marginBottom = "4px";

  const logText = document.createElement("span");
  logText.textContent = `[${timeStamp}] [${nowTime}] ${event}`;
  logText.style.flex = "1";

  const delBtn = document.createElement("button");
  delBtn.textContent = "刪除";
  delBtn.style.marginLeft = "10px";
  delBtn.style.backgroundColor = "#f44336";
  delBtn.style.color = "white";
  delBtn.style.border = "none";
  delBtn.style.borderRadius = "4px";
  delBtn.style.cursor = "pointer";
  delBtn.onclick = function () {
    if (confirm("是否刪除？")) {
      logContainer.removeChild(logEntry);
    }
  };

  logEntry.appendChild(logText);
  logEntry.appendChild(delBtn);
  logContainer.appendChild(logEntry);

  // ✅ 這行是送資料到 Google Sheet
  sendToGoogleSheet(timeStamp, nowTime, event);
}
let beatInterval = null;


function startCPR() {
  recordEvent("CPR 開始");
  if (!startTime) startTime = new Date();

  timers.push(setTimeout(() => alert("30秒後心律分析"), 90000));
  timers.push(setTimeout(() => alert("10秒後心律分析"), 110000));
  timers.push(setInterval(() => alert("提醒：CPR 執行中，請考慮 5H5T？"), 120000));

  if (!beatInterval) {
    playBeep(); // 立即嗶第一下
    beatInterval = setInterval(playBeep, 600); // 每 600 毫秒嗶一次（100bpm）
  }
}

function stopCPR() {
  recordEvent("CPR 停止");
  timers.forEach(t => clearTimeout(t) || clearInterval(t));
  timers = [];
  if (beatInterval) {
    clearInterval(beatInterval);
    beatInterval = null;
  }
}
function aedAnalyze() {
  recordEvent("AED 分析開始（倒數 10 秒）");
  setTimeout(() => recordEvent("AED 分析結束"), 10000);
}
function switchCPR() {
  recordEvent("CPR 換人");
  setTimeout(() => alert("2分鐘已到，請考慮 CPR 換人"), 120000);
}
function giveEpinephrine() {
  alert("1mg IVP");
  recordEvent("Epinephrine 給藥");
  document.getElementById("epiCount").innerText = ++epiCount;
}
function giveAmiodarone() {
  if (++amioCount === 1) {
    alert("300mg IVP (考慮Lidocaine?)");
    recordEvent("Amiodarone 300mg 給藥");
  } else if (amioCount === 2) {
    alert("150mg IVP");
    recordEvent("Amiodarone 150mg 給藥");
    const btn = document.getElementById("amioBtn");
    btn.disabled = true;
    btn.style.opacity = 0.5;
  }
  document.getElementById("amioCount").innerText = amioCount;
}
function giveLidocaine() {
  if (++lidoCount === 1) {
    alert("1-1.5mg/kg IVP");
    recordEvent("Lidocaine 劑量(?)mg");
  } else if (lidoCount === 2) {
    alert("0.5-0.75mg/kg IVP");
    recordEvent("Lidocaine 劑量(?)mg");
    const btn = document.getElementById("lidoBtn");
    btn.disabled = true;
    btn.style.opacity = 0.5;
  }
  document.getElementById("lidoCount").innerText = lidoCount;
}
function recordShock() {
  recordEvent("Shock!");
  document.getElementById("shockCount").innerText = ++shockCount;
}
function recordEndoTube() {
  const cm = prompt("確認 Fix\n請輸入數值（19-23cm）或取消：", "20");
  if (cm && ["19","20","21","22","23"].includes(cm)) {
    recordEvent(`Fix ${cm}cm`);
  }
}
function resetLog() {
  if (confirm("確定要清除所有紀錄？")) {
    document.getElementById("log").innerText = "";
    epiCount = amioCount = lidoCount = shockCount = 0;
    ["epiCount", "amioCount", "lidoCount", "shockCount"].forEach(id => document.getElementById(id).innerText = "0");
    ["amioBtn", "lidoBtn"].forEach(id => {
      const btn = document.getElementById(id);
      btn.disabled = false;
      btn.style.opacity = 1;
    });
    startTime = null;
    timers.forEach(t => clearTimeout(t) || clearInterval(t));
    timers = [];

    // ✅ 新增這段來清除輸入欄位的內容
    const inputs = document.querySelectorAll("input[type='text'], input[type='number'], textarea");
    inputs.forEach(input => input.value = "");
  }
}
function toggleGender(selected) {
  const maleBtn = document.getElementById("maleBtn");
  const femaleBtn = document.getElementById("femaleBtn");
  if (selected === 'male') {
    maleBtn.classList.toggle('selected');
    femaleBtn.classList.remove('selected');
  } else {
    femaleBtn.classList.toggle('selected');
    maleBtn.classList.remove('selected');
  }
}
function toggleMarker(btn) {
  btn.classList.toggle('toggled');
}
  let isMuted = false;

function toggleMute() {
  const btn = document.getElementById("muteBtn");
  isMuted = !isMuted;
  btn.innerText = isMuted ? "Unmute" : "Mute";
  btn.className = isMuted ? "light" : "dark";
}

function playBeep() {
  if (isMuted) return;
  const beep = document.getElementById("beepSound");
  beep.currentTime = 0;
  beep.play();
}
function sendToGoogleSheet(timeCode, realTime, event) {
  fetch("https://script.google.com/macros/s/AKfycbwnnv0blAD56hjFlx3xEdeExJktzzPcepR_bhv33mfu4HiEXePqjGP2ZMZ8xns6Jwmh2Q/exec", {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      timeCode: timeCode,
      realTime: realTime,
      event: event
    })
  })
  .then(response => console.log("✅ 已送出至 Google Sheet"))
  .catch(error => console.error("❌ 發送失敗", error));
}  
</script>

</body>
</html>
