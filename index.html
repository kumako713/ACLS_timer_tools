<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ACLS Timer Tool</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      text-align: center;
    }
    .header-text {
      font-size: 32px;
      background-color: #e53935;
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      display: inline-block;
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      border-radius: 6px;
      color: white;
      cursor: pointer;
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin-bottom: 10px;
    }
    .red { background-color: #e53935; }
    .yellow { background-color: #fbc02d; color: black; }
    .green { background-color: #40e0d0; color: black; }
    .blue { background-color: #4fc3f7; color: black; }
    .gray { background-color: #b0bec5; color: black; }
    .black { background-color: #000000; color: white; }
    #log {
      margin-top: 20px;
      white-space: pre-line;
      border-top: 1px solid #ccc;
      padding-top: 10px;
      text-align: left;
      max-width: 700px;
      margin-left: auto;
      margin-right: auto;
    }
    #clock, #countInfo {
      font-size: 20px;
      margin-bottom: 10px;
      color: #333;
    }
  </style>
</head>
<body>

<div class="header-text">ACLS Timer Tool</div>
<audio id="beep-audio" src="beep-01a.mp3" preload="auto"></audio>

<div id="clock"></div>
<div id="countInfo">
  Epinephrine 次數：<span id="epiCount">0</span><br>
  Amiodarone 次數：<span id="amioCount">0</span><br>
  Lidocaine 次數：<span id="lidoCount">0</span>
</div>

<div class="row">
  <button class="red" onclick="startCPR()">Start CPR</button>
  <button class="red" onclick="aedAnalyze()">AED Analyze</button>
  <button class="red" onclick="switchCPR()">Switch CPR</button>
</div>

<div class="row">
  <button class="yellow" onclick="giveEpinephrine()">Epinephrine</button>
  <button class="yellow" id="amioBtn" onclick="giveAmiodarone()">Amiodarone</button>
  <button class="yellow" id="lidoBtn" onclick="giveLidocaine()">Lidocaine</button>
</div>

<div class="row">
  <button class="green" onclick="recordEvent('IV')">IV</button>
  <button class="green" onclick="recordEvent('IO')">IO</button>
  <button class="green" onclick="recordEndoTube()">Endo tube</button>
</div>

<div class="row">
  <button class="blue" onclick="recordEvent('ROSC')">ROSC</button>
  <button class="black" onclick="toggleMetronome()">節拍器靜音/播放</button>
</div>

<div class="row">
  <button class="gray" onclick="resetLog()">Reset</button>
</div>

<div id="log"></div>

<script>
  let startTime = null;
  let cprSwitchTimer = null;
  let epiReminderTimer = null;
  let h5tReminderTimer = null;
  let metronomeInterval = null;
  let metronomeOn = false;

  let epiCount = 0;
  let amioCount = 0;
  let lidoCount = 0;

  function updateClock() {
    const now = new Date();
    document.getElementById("clock").innerText = "當前時間：" + now.toLocaleString();
  }
  setInterval(updateClock, 1000);
  updateClock();

  function getCurrentTime() {
    return new Date();
  }

  function formatTimeDiff(ms) {
    let totalSeconds = Math.floor(ms / 1000);
    let minutes = String(Math.floor(totalSeconds / 60)).padStart(2, '0');
    let seconds = String(totalSeconds % 60).padStart(2, '0');
    return `${minutes}:${seconds}`;
  }

  function formatAbsoluteTime(date) {
    return date.toLocaleString();
  }

  function recordEvent(event) {
    const now = getCurrentTime();
    if (!startTime) {
      startTime = now;
    }
    const elapsed = formatTimeDiff(now - startTime);
    const absolute = formatAbsoluteTime(now);
    const log = document.getElementById("log");
    log.innerText += `[${elapsed}] (${absolute}) ${event}\n`;
  }

  function recordEndoTube() {
    const cm = prompt("確認 Fix\n請輸入數值（19-23cm）或取消：", "20");
    if (cm && ["19", "20", "21", "22", "23"].includes(cm)) {
      recordEvent(`Fix ${cm}cm`);
    }
  }

  function giveEpinephrine() {
    alert("1mg IVP");
    epiCount++;
    document.getElementById("epiCount").innerText = epiCount;
    recordEvent("Epinephrine 給藥");
    scheduleEpinephrineReminder();
  }

  function giveAmiodarone() {
    amioCount++;
    if (amioCount === 1) {
      alert("300mg IVP (考慮Lidocaine?)");
      recordEvent("Amiodarone 300mg 給藥");
    } else if (amioCount === 2) {
      alert("150mg IVP");
      recordEvent("Amiodarone 150mg 給藥");
      document.getElementById("amioBtn").disabled = true;
      document.getElementById("amioBtn").style.opacity = 0.5;
    }
    document.getElementById("amioCount").innerText = amioCount;
  }

  function giveLidocaine() {
    lidoCount++;
    if (lidoCount === 1) {
      alert("1-1.5mg/kg IVP");
      recordEvent("Lidocaine 1-1.5mg/kg 給藥");
    } else if (lidoCount === 2) {
      alert("0.5-0.75mg/kg IVP");
      recordEvent("Lidocaine 0.5-0.75mg/kg 給藥");
      document.getElementById("lidoBtn").disabled = true;
      document.getElementById("lidoBtn").style.opacity = 0.5;
    }
    document.getElementById("lidoCount").innerText = lidoCount;
  }

  function scheduleEpinephrineReminder() {
    if (epiReminderTimer) {
      clearTimeout(epiReminderTimer);
    }
    epiReminderTimer = setTimeout(() => {
      alert("提醒：已過 4 分鐘，請考慮再次給予 Epinephrine！");
    }, 4 * 60 * 1000);
  }

  function aedAnalyze() {
    recordEvent("AED 分析開始（倒數 10 秒）");
    setTimeout(() => {
      recordEvent("AED 分析結束");
    }, 10000);
  }

  function switchCPR() {
    recordEvent("CPR 換人");
    if (cprSwitchTimer) {
      clearTimeout(cprSwitchTimer);
    }
    cprSwitchTimer = setTimeout(() => {
      alert("提醒：2 分鐘已到，建議 CPR 換人！");
    }, 2 * 60 * 1000);
  }

  function startCPR() {
    recordEvent("CPR 開始");
    if (!startTime) {
      startTime = new Date();
    }
    triggerH5TReminder();
    setTimeout(() => startMetronome(100), 2000);
  }

  function triggerH5TReminder() {
    if (h5tReminderTimer) {
      clearInterval(h5tReminderTimer);
    }
    h5tReminderTimer = setInterval(() => {
      alert("提醒：CPR 執行中，請考慮 5H5T？");
    }, 2 * 60 * 1000);
  }

  function playBeep() {
    const audio = document.getElementById("beep-audio");
    if (audio) {
      audio.currentTime = 0;
      audio.play();
    }
  }

  function startMetronome(bpm = 100) {
    stopMetronome();
    metronomeOn = true;
    const interval = 60000 / bpm;
    metronomeInterval = setInterval(() => {
      if (metronomeOn) playBeep();
    }, interval);
  }

  function stopMetronome() {
    clearInterval(metronomeInterval);
    metronomeInterval = null;
  }

  function toggleMetronome() {
    metronomeOn = !metronomeOn;
  }

  function resetLog() {
    if (confirm("確定要清除所有紀錄？")) {
      document.getElementById("log").innerText = "";
      document.getElementById("epiCount").innerText = "0";
      document.getElementById("amioCount").innerText = "0";
      document.getElementById("lidoCount").innerText = "0";
      epiCount = 0;
      amioCount = 0;
      lidoCount = 0;
      startTime = null;
      document.getElementById("amioBtn").disabled = false;
      document.getElementById("amioBtn").style.opacity = 1;
      document.getElementById("lidoBtn").disabled = false;
      document.getElementById("lidoBtn").style.opacity = 1;
      if (cprSwitchTimer) clearTimeout(cprSwitchTimer);
      if (epiReminderTimer) clearTimeout(epiReminderTimer);
      if (h5tReminderTimer) clearInterval(h5tReminderTimer);
      stopMetronome();
    }
  }
</script>

</body>
</html>
